<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        // Configuration
        const ITEMS_PER_PAGE = 20;
        const LAZY_LOAD_THRESHOLD = 100; // px from bottom to trigger load
        const PLACEHOLDER_IMAGE_URL = 'https://movie-fcs.fwh.is/cinecraze/cinecraze.png';
        
        // SAMPLE DATA - Replace this with your actual data source
        let cineData = null;
        let cachedContent = [];
        let currentPage = 1;
        let totalPages = 0;
        let isFetching = false;
        let isInitialLoad = true; // Flag for initial content shuffle
        
        // DOM Elements
        const elements = {
            header: document.querySelector('header'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            closeSearchBtn: document.querySelector('.close-search-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            gridViewBtn: document.getElementById('grid-view'),
            listViewBtn: document.getElementById('list-view'),
            contentGrid: document.getElementById('content-grid'),
            contentList: document.getElementById('content-list'),
            categoryFilter: document.getElementById('category-filter'),
            genreFilter: document.getElementById('genre-filter'),
            countryFilter: document.getElementById('country-filter'),
            sortFilter: document.getElementById('sort-filter'),
            viewerPage: document.getElementById('viewer-page'),
            viewerTitle: document.getElementById('viewer-title'),
            viewerDescription: document.getElementById('viewer-description'),
            viewerRating: document.getElementById('viewer-rating'),
            viewerDuration: document.getElementById('viewer-duration'),
            viewerYear: document.getElementById('viewer-year'),
            viewerCountry: document.getElementById('viewer-country'),
            serverSelect: document.getElementById('quality-select'),
            playerServerSelector: document.getElementById('player-server-selector'),
            episodeSelectorContainer: document.getElementById('episode-selector-container'),
            episodeSelector: document.getElementById('episode-selector'),
            seasonSelector: document.getElementById('season-selector'),
            seasonsGrid: document.getElementById('seasons-grid'),
            relatedGrid: document.getElementById('related-grid'),
            player: document.getElementById('player'),
            carouselInner: document.getElementById('carousel-inner'),
            carouselPrev: document.getElementById('carousel-prev'),
            carouselNext: document.getElementById('carousel-next'),
            carouselIndicators: document.getElementById('carousel-indicators'),
            mobileSearchBtn: document.getElementById('mobile-search-btn'),
            searchContainer: document.querySelector('.search-container'),
            backButton: document.getElementById('back-button'),
            loadMoreBtn: document.getElementById('load-more-btn'),
            loadMoreContainer: document.getElementById('load-more-container'),
            loadingSpinner: document.getElementById('loading-spinner'),
            shareVideoBtn: document.getElementById('share-video-btn'),
            likeBtn: document.getElementById('like-btn'),
            dislikeBtn: document.getElementById('dislike-btn'),
            likeCountSpan: document.getElementById('like-count-span'),
            dislikeCountSpan: document.getElementById('dislike-count-span'),
            // Containers for moving elements
            relatedVideosContainer: document.querySelector('.related-videos'),
            videoDetailsContainer: document.querySelector('.video-details')
        };
        
        // State
        let currentView = 'grid';
        let currentContentInfo = {}; // To store current viewed content info for save/like
        let currentContent = [];
        let currentCarouselIndex = 0;
        let playerInstance = null;
        let currentEpisode = null;
        let currentSeason = null;
        let currentSeries = null;
        
        // Function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Sort content based on criteria
        function sortContent(content, criteria) {
            return [...content].sort((a, b) => {
                switch(criteria) {
                    case 'newest':
                        return (parseInt(b.Year) || 0) - (parseInt(a.Year) || 0);
                    case 'popular':
                        return (parseFloat(b.Rating) || 0) - (parseFloat(a.Rating) || 0);
                    case 'rating':
                        return (parseFloat(b.Rating) || 0) - (parseFloat(a.Rating) || 0);
                    default:
                        return 0;
                }
            });
        }

        // --- Episode Navigation Helper Functions ---
        function getCurrentEpisodeIndex() {
            if (!currentSeries || !currentSeries.Seasons || !currentSeason || !currentEpisode) {
                return null;
            }
            const seasonIndex = currentSeries.Seasons.findIndex(s => s.Season === currentSeason.Season);
            if (seasonIndex === -1) {
                return null;
            }
            const sortedEpisodes = [...currentSeries.Seasons[seasonIndex].Episodes].sort((a, b) => a.Episode - b.Episode);
            const episodeIndex = sortedEpisodes.findIndex(ep => ep.Episode === currentEpisode.Episode);
            if (episodeIndex === -1) {
                return null;
            }
            return { seasonIndex, episodeIndex, sortedEpisodes };
        }

        function findNextEpisode() {
            const currentIndexData = getCurrentEpisodeIndex();
            if (!currentIndexData) return null;
            let { seasonIndex, episodeIndex, sortedEpisodes } = currentIndexData;
            episodeIndex++;
            if (episodeIndex < sortedEpisodes.length) {
                return { season: currentSeries.Seasons[seasonIndex], episode: sortedEpisodes[episodeIndex] };
            }
            seasonIndex++;
            if (seasonIndex < currentSeries.Seasons.length) {
                const nextSeasonEpisodes = [...currentSeries.Seasons[seasonIndex].Episodes].sort((a, b) => a.Episode - b.Episode);
                if (nextSeasonEpisodes.length > 0) {
                    return { season: currentSeries.Seasons[seasonIndex], episode: nextSeasonEpisodes[0] };
                }
            }
            return null;
        }

        function findPreviousEpisode() {
            const currentIndexData = getCurrentEpisodeIndex();
            if (!currentIndexData) return null;
            let { seasonIndex, episodeIndex, sortedEpisodes } = currentIndexData;
            episodeIndex--;
            if (episodeIndex >= 0) {
                return { season: currentSeries.Seasons[seasonIndex], episode: sortedEpisodes[episodeIndex] };
            }
            seasonIndex--;
            if (seasonIndex >= 0) {
                const targetSeason = currentSeries.Seasons[seasonIndex];
                const prevSeasonEpisodes = [...targetSeason.Episodes].sort((a, b) => a.Episode - b.Episode);
                if (prevSeasonEpisodes.length > 0) {
                    return { season: targetSeason, episode: prevSeasonEpisodes[prevSeasonEpisodes.length - 1] };
                }
            }
            return null;
        }
        // --- End Episode Navigation Helper Functions ---

        // --- Function to Update Prev/Next Button States ---
        function updateNavButtonStates() {
            const prevBtn = document.getElementById('plyr-prev-episode-btn');
            const nextBtn = document.getElementById('plyr-next-episode-btn');

            if (!prevBtn || !nextBtn) {
                return;
            }

            if (!currentSeries || currentSeries.type !== 'series') {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            const prevEpisodeData = findPreviousEpisode();
            const nextEpisodeData = findNextEpisode();
            prevBtn.disabled = !prevEpisodeData;
            nextBtn.disabled = !nextEpisodeData;
        }
        // --- End Button State Update Function ---

        // --- Function to Rebuild Custom Prev/Next Player Controls ---
        function rebuildCustomPlayerControls(player, activeSeries) {
            if (!player || !player.elements || !player.elements.controls) {
                return;
            }
            const controlsContainer = player.elements.controls;

            const existingPrevBtnContainer = controlsContainer.querySelector('.plyr__control--prev-episode-container');
            const existingNextBtnContainer = controlsContainer.querySelector('.plyr__control--next-episode-container');
            if (existingPrevBtnContainer) existingPrevBtnContainer.remove();
            if (existingNextBtnContainer) existingNextBtnContainer.remove();

            if (activeSeries && activeSeries.type === 'series') {
                const prevButton = document.createElement('button');
                prevButton.type = 'button';
                prevButton.className = 'plyr__control plyr__control--prev-episode';
                prevButton.dataset.plyr = 'prevtrack';
                prevButton.id = 'plyr-prev-episode-btn';
                prevButton.innerHTML = '<i class="fas fa-step-backward"></i>';
                prevButton.setAttribute('aria-label', 'Previous Episode');

                const nextButton = document.createElement('button');
                nextButton.type = 'button';
                nextButton.className = 'plyr__control plyr__control--next-episode';
                nextButton.dataset.plyr = 'nexttrack';
                nextButton.id = 'plyr-next-episode-btn';
                nextButton.innerHTML = '<i class="fas fa-step-forward"></i>';
                nextButton.setAttribute('aria-label', 'Next Episode');

                const playButtonControlItem = Array.from(controlsContainer.children).find(item => item.querySelector('button[data-plyr="play"]'));

                const prevButtonContainer = document.createElement('div');
                prevButtonContainer.className = 'plyr__controls__item plyr__control--prev-episode-container';
                prevButtonContainer.appendChild(prevButton);

                const nextButtonContainer = document.createElement('div');
                nextButtonContainer.className = 'plyr__controls__item plyr__control--next-episode-container';
                nextButtonContainer.appendChild(nextButton);

                if (playButtonControlItem) {
                    playButtonControlItem.insertAdjacentElement('beforebegin', prevButtonContainer);
                    playButtonControlItem.insertAdjacentElement('afterend', nextButtonContainer);
                } else {
                    const firstRealControl = Array.from(controlsContainer.children).find(child => child.matches('.plyr__controls__item:not([hidden])') && !child.querySelector('.plyr__progress__container') && !child.querySelector('.plyr__time'));
                    if (firstRealControl) {
                        controlsContainer.insertBefore(prevButtonContainer, firstRealControl.nextSibling);
                        controlsContainer.insertBefore(nextButtonContainer, prevButtonContainer.nextSibling);
                    } else {
                        controlsContainer.appendChild(prevButtonContainer);
                        controlsContainer.appendChild(nextButtonContainer);
                    }
                    console.warn("Plyr play button container not found for precise custom button insertion. Used fallback.");
                }

                prevButton.addEventListener('click', () => {
                    const prevData = findPreviousEpisode();
                    if (prevData) {
                        if (currentSeason.Season !== prevData.season.Season) {
                            openSeason(prevData.season, prevData.episode.Episode);
                        } else {
                            playEpisode(prevData.episode);
                        }
                    }
                });

                nextButton.addEventListener('click', () => {
                    const nextData = findNextEpisode();
                    if (nextData) {
                        if (currentSeason.Season !== nextData.season.Season) {
                            openSeason(nextData.season, nextData.episode.Episode);
                        } else {
                            playEpisode(nextData.episode);
                        }
                    }
                });
                updateNavButtonStates();
            }
        }
        // --- End Rebuild Custom Player Controls ---
        
        // Initialize the app
        function init() {
            fetchData().then(() => {
                renderCarousel();
                renderContentFilters();
                renderContent();
                setupEventListeners();
                updateCarousel();
                setupLazyLoading();
                history.replaceState({ page: 'browse' }, 'Browse Content', window.location.pathname + window.location.search);
            });
        }
        
        async function fetchData() {
            try {
                elements.loadingSpinner.style.display = 'block';
                const response = await fetch("https://movie-fcs.fwh.is/cinecraze/pagsure.json");
                if (!response.ok) throw new Error("Online source failed");
                cineData = await response.json();
                fixDataInconsistencies();
            } catch (err) {
                console.warn("⚠️ Online source failed, trying offline...", err);
                try {
                    const offlineResponse = await fetch("./pagsure.json");
                    if (!offlineResponse.ok) throw new Error("Offline file not found");
                    cineData = await offlineResponse.json();
                    fixDataInconsistencies();
                } catch (err2) {
                    console.error("❌ Both online and offline data failed to load.", err2);
                    alert("Data loading failed. Please check your internet or local file.");
                }
            } finally {
                elements.loadingSpinner.style.display = 'none';
            }
        }
        
        function fixDataInconsistencies() {
            if (!cineData || !cineData.Categories) return;
            cineData.Categories.forEach(category => {
                category.Entries = category.Entries.map(entry => {
                    if (entry.Title && entry.Title.endsWith(' -')) entry.Title = entry.Title.slice(0, -1).trim();
                    if (entry.Title === "Naruto Kid") {
                        if (!entry.Rating) entry.Rating = "8.5";
                        if (!entry.Country) entry.Country = "Japan";
                        entry.Description = "An anime series in Tagalog Dub";
                        entry.type = "series";
                        if (!entry.Seasons) entry.Seasons = [{ Season: 1, SeasonPoster: entry.Poster, Episodes: [{ Episode: 1, Title: "The Beginning", Description: "The start of Naruto's journey", Servers: [{ name: "480p", url: "https://example.com/naruto-ep1-480p" }] }] }];
                    }
                    if (entry.Title === "Boruto: Naruto Next Generations") entry.Description = "The next generation of ninja adventures in the Hidden Leaf Village under the leadership of the Seventh Hokage Naruto Uzumaki.";
                    return entry;
                });
            });
        }
        
        function renderCarousel() {
            if (!cineData || !cineData.Categories) return;
            const featuredContent = [];
            cineData.Categories[0].Entries.slice(0, 3).forEach(movie => featuredContent.push({ type: 'movie', title: movie.Title, description: movie.Description, image: movie.Poster }));
            cineData.Categories[1].Entries.slice(0, 1).forEach(series => featuredContent.push({ type: 'series', title: series.Title, description: series.Description || `Popular ${series.SubCategory} series`, image: series.Poster }));
            cineData.Categories[2].Entries.slice(0, 1).forEach(live => featuredContent.push({ type: 'live', title: live.Title, description: live.Description, image: live.Poster }));
            shuffleArray(featuredContent);
            elements.carouselInner.innerHTML = '';
            elements.carouselIndicators.innerHTML = '';
            featuredContent.forEach((item, index) => {
                const carouselItem = document.createElement('div'); carouselItem.className = 'carousel-item';
                carouselItem.innerHTML = `<img src="${item.image}" alt="${item.title}" onerror="this.onerror=null; this.src='${PLACEHOLDER_IMAGE_URL}';"><div class="carousel-content"><h2>${item.title}</h2><p>${item.description}</p></div>`;
                elements.carouselInner.appendChild(carouselItem);
                const indicator = document.createElement('div'); indicator.className = 'indicator'; indicator.dataset.index = index; if (index === 0) indicator.classList.add('active');
                elements.carouselIndicators.appendChild(indicator);
                indicator.addEventListener('click', () => { currentCarouselIndex = index; updateCarousel(); });
                carouselItem.addEventListener('click', () => { cineData.Categories.forEach(category => { const found = category.Entries.find(entry => entry.Title === item.title); if (found) openViewer({ ...found, type: category.MainCategory.toLowerCase().includes('movie') ? 'movie' : category.MainCategory.toLowerCase().includes('series') ? 'series' : 'live' }); }); });
            });
        }
        
        function renderContentFilters() {
            if (!cineData || !cineData.Categories) return;
            const genres = new Set(); const countries = new Set();
            cineData.Categories.forEach(category => category.Entries.forEach(entry => { if (entry.SubCategory) genres.add(entry.SubCategory); if (entry.Country) countries.add(entry.Country); }));
            elements.genreFilter.innerHTML = '<option value="all">All Genres</option>'; genres.forEach(genre => { const option = document.createElement('option'); option.value = genre.toLowerCase(); option.textContent = genre; elements.genreFilter.appendChild(option); });
            elements.countryFilter.innerHTML = '<option value="all">All Countries</option>'; countries.forEach(country => { const option = document.createElement('option'); option.value = country.toLowerCase(); option.textContent = country; elements.countryFilter.appendChild(option); });
        }
        
        function renderContent() {
            if (!cineData || !cineData.Categories) return;
            currentPage = 1; currentContent = [];
            const category = elements.categoryFilter.value; const genre = elements.genreFilter.value; const country = elements.countryFilter.value; const sortBy = elements.sortFilter.value;
            cineData.Categories.forEach(cat => { if (category === 'all' || cat.MainCategory.toLowerCase().includes(category)) { cat.Entries.forEach(entry => { const genreMatch = genre === 'all' || (entry.SubCategory && entry.SubCategory.toLowerCase().includes(genre)); const countryMatch = country === 'all' || (entry.Country && entry.Country.toLowerCase().includes(country)); if (genreMatch && countryMatch) currentContent.push({ ...entry, type: cat.MainCategory.toLowerCase().includes('movie') ? 'movie' : cat.MainCategory.toLowerCase().includes('series') ? 'series' : 'live' }); }); } });
            if (isInitialLoad) { currentContent = shuffleArray(currentContent); isInitialLoad = false; } else { currentContent = sortContent(currentContent, sortBy); }
            totalPages = Math.ceil(currentContent.length / ITEMS_PER_PAGE); cachedContent = [...currentContent]; renderCurrentView(); updateLoadMoreButton();
        }
        
        function renderCurrentView() { if (currentView === 'grid') renderGridView(); else renderListView(); }
        function renderGridView() { elements.contentGrid.innerHTML = ''; const itemsToRender = currentContent.slice(0, currentPage * ITEMS_PER_PAGE); itemsToRender.forEach(item => { elements.contentGrid.appendChild(createContentCard(item, 'grid')); }); elements.contentGrid.style.display = 'grid'; elements.contentList.style.display = 'none'; }
        function renderListView() { elements.contentList.innerHTML = ''; const itemsToRender = currentContent.slice(0, currentPage * ITEMS_PER_PAGE); itemsToRender.forEach(item => { elements.contentList.appendChild(createContentCard(item, 'list')); }); elements.contentGrid.style.display = 'none'; elements.contentList.style.display = 'flex'; }
        function createContentCard(item, viewType) {
            const card = document.createElement('div'); card.className = `content-card ${viewType}`; card.dataset.id = item.Title.replace(/\s+/g, '-').toLowerCase(); card.dataset.type = item.type;
            let badge = ''; if (item.type === 'movie') badge = '<div class="card-badge badge-movie">MOVIE</div>'; else if (item.type === 'series') badge = '<div class="card-badge badge-series">SERIES</div>'; else if (item.type === 'live') badge = '<div class="card-badge badge-live">LIVE</div>';
            card.innerHTML = `<div class="card-img"><img data-src="${item.Thumbnail || item.Poster}" alt="${item.Title}" class="lazy-image" loading="lazy" onerror="this.onerror=null; this.src='${PLACEHOLDER_IMAGE_URL}';">${badge}</div><div class="card-info"><h3 class="card-title">${item.Title}</h3><div class="card-meta"><span><i class="fas fa-star"></i> ${item.Rating || 'N/A'}</span><span><i class="fas fa-clock"></i> ${item.Duration || 'N/A'}</span>${viewType === 'list' ? `<span><i class="fas fa-globe"></i> ${item.Country || 'N/A'}</span>` : ''}</div>${viewType === 'list' ? `<p class="card-description">${item.Description || ''}</p>` : ''}</div>`;
            card.addEventListener('click', () => openViewer(item)); return card;
        }
        function loadMoreContent() { if (isFetching) return; isFetching = true; elements.loadingSpinner.style.display = 'block'; setTimeout(() => { currentPage++; if (currentView === 'grid') renderGridView(); else renderListView(); updateLoadMoreButton(); setupLazyLoading(); isFetching = false; elements.loadingSpinner.style.display = 'none'; }, 300); }
        function updateLoadMoreButton() { elements.loadMoreContainer.style.display = currentPage < totalPages ? 'flex' : 'none'; }
        function setupLazyLoading() { const lazyImages = document.querySelectorAll('.lazy-image'); const lazyLoad = () => { lazyImages.forEach(img => { if (img.classList.contains('loaded')) return; const rect = img.getBoundingClientRect(); if (rect.top < window.innerHeight + LAZY_LOAD_THRESHOLD) { img.src = img.dataset.src; img.onload = () => img.classList.add('loaded'); } }); }; lazyLoad(); window.addEventListener('scroll', lazyLoad); window.addEventListener('resize', lazyLoad); }
        
        function openViewer(content) {
            if (playerInstance) playerInstance.stop();
            currentContentInfo = { id: content.Title, title: content.Title, type: content.type, description: content.Description, poster: content.Poster || content.Thumbnail, Servers: content.Servers };
            incrementViewCount(content.Title);
            history.pushState({ page: 'viewer', contentId: content.Title }, 'View Content', '#viewer');
            document.querySelector('.carousel').style.display = 'none'; document.querySelector('.filters-section').style.display = 'none'; document.querySelector('.content-container').style.display = 'none';
            elements.viewerTitle.textContent = content.Title; elements.viewerDescription.textContent = content.Description || 'No description available.';
            elements.episodeSelectorContainer.style.display = 'none'; elements.episodeSelector.innerHTML = '<option value="">Select Episode</option>';
            elements.seasonSelector.style.display = 'none';
            if (elements.episodeSelectorContainer.parentNode !== elements.videoDetailsContainer) elements.videoDetailsContainer.appendChild(elements.episodeSelectorContainer);
            if (elements.seasonSelector.parentNode !== elements.videoDetailsContainer) elements.videoDetailsContainer.appendChild(elements.seasonSelector);
            currentSeason = null; currentEpisode = null; currentSeries = content;
            if (content.Servers) updateQualitySelector(content.Servers);
            elements.seasonsGrid.innerHTML = '';
            if (content.type === 'series' && content.Seasons) {
                if (elements.relatedVideosContainer) { elements.relatedVideosContainer.prepend(elements.seasonSelector); elements.relatedVideosContainer.prepend(elements.episodeSelectorContainer); }
                elements.seasonSelector.style.display = 'block';
                content.Seasons.forEach(season => { const seasonCard = document.createElement('div'); seasonCard.className = 'season-card'; seasonCard.innerHTML = `<img src="${season.SeasonPoster || content.Thumbnail}" alt="Season ${season.Season}" onerror="this.onerror=null; this.src='${PLACEHOLDER_IMAGE_URL}';"><div class="season-info"><h4>Season ${season.Season}</h4></div>`; seasonCard.addEventListener('click', () => openSeason(season)); elements.seasonsGrid.appendChild(seasonCard); });
                if (content.Seasons.length > 0) openSeason(content.Seasons[0]);
            } else if (content.type === 'movie' && content.Servers && content.Servers.length > 0) {
                playUrl(content.Servers[0].url);
            }
            elements.relatedGrid.innerHTML = ''; const relatedContent = cachedContent.filter(item => item.Title !== content.Title).sort(() => 0.5 - Math.random()).slice(0, 8);
            relatedContent.forEach(item => { const card = document.createElement('div'); card.className = 'related-card'; card.innerHTML = `<div class="related-thumbnail"><img src="${item.Thumbnail || item.Poster}" alt="${item.Title}" onerror="this.onerror=null; this.src='${PLACEHOLDER_IMAGE_URL}';"></div><div class="related-info"><h4>${item.Title}</h4><div class="related-channel">CineCraze</div><div class="related-meta">${item.Rating || 'N/A'} • ${item.Year || ''}</div></div>`; card.addEventListener('click', () => openViewer(item)); elements.relatedGrid.appendChild(card); });
            elements.viewerPage.style.display = 'block';
            if (!playerInstance) {
                playerInstance = new Plyr('#player', {
                    controls: ['play-large', 'prevtrack', 'play', 'nexttrack', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'fullscreen'],
                    youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3 }
                });
                playerInstance.on('enterfullscreen', () => { if (screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape').catch(error => console.log('Orientation lock failed: ', error)); });
                playerInstance.on('exitfullscreen', () => { if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock(); if (window.innerWidth <= 768) { elements.searchContainer.classList.remove('show'); elements.searchContainer.style.display = ''; } });
                playerInstance.on('loadeddata', () => { // ADDED loadeddata listener
                    setTimeout(() => { rebuildCustomPlayerControls(playerInstance, currentSeries); }, 50);
                });
            }
            rebuildCustomPlayerControls(playerInstance, currentSeries); // Call on initial open
            window.scrollTo(0, 0);
            elements.shareVideoBtn.removeEventListener('click', handleShareVideo); elements.shareVideoBtn.addEventListener('click', handleShareVideo);
            updateLikeDislikeUI(currentContentInfo.id); elements.likeBtn.removeEventListener('click', handleLike); elements.likeBtn.addEventListener('click', handleLike); elements.dislikeBtn.removeEventListener('click', handleDislike); elements.dislikeBtn.addEventListener('click', handleDislike);
        }
        
        function playUrl(url) {
            if (!url || !playerInstance) return;
            if (isYouTubeUrl(url)) {
                const videoId = extractYouTubeId(url);
                if (videoId) { playerInstance.source = { type: 'video', sources: [{ src: videoId, provider: 'youtube' }] }; return; }
            }
            playerInstance.source = { type: 'video', sources: [{ src: url, type: url.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4' }] };
        }
        
        function isYouTubeUrl(url) { return url.includes('youtube.com') || url.includes('youtu.be'); }
        function extractYouTubeId(url) { const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); return (match && match[2].length === 11) ? match[2] : null; }
        
        function updateQualitySelector(servers) {
            elements.serverSelect.innerHTML = ''; if (servers) { servers.forEach((server, index) => { const option = document.createElement('option'); option.value = server.url; option.textContent = server.name; if (index === 0) option.selected = true; elements.serverSelect.appendChild(option); }); }
            elements.serverSelect.onchange = function() { playUrl(this.value); };
        }
        
        function openSeason(season, targetEpisodeNumber = null) {
            currentSeason = season;
            if (currentSeries && currentSeries.Seasons) { const seasonData = currentSeries.Seasons.find(s => s.Season === season.Season); if (seasonData && seasonData.Episodes) seasonData.Episodes.sort((a,b) => a.Episode - b.Episode); }
            elements.episodeSelector.innerHTML = '<option value="">Select Episode</option>';
            season.Episodes.forEach(ep => { const option = document.createElement('option'); option.value = ep.Episode; option.textContent = `Episode ${ep.Episode}: ${ep.Title}`; elements.episodeSelector.appendChild(option); });
            elements.episodeSelectorContainer.style.display = 'block';
            let episodeToPlay = null;
            if (targetEpisodeNumber !== null) episodeToPlay = season.Episodes.find(ep => ep.Episode === targetEpisodeNumber);
            if (!episodeToPlay && season.Episodes.length > 0) episodeToPlay = season.Episodes[0];
            if (episodeToPlay) { elements.episodeSelector.value = episodeToPlay.Episode; playEpisode(episodeToPlay); }
            else { if (playerInstance) playerInstance.stop(); currentEpisode = null; elements.episodeSelector.value = ""; updateNavButtonStates(); console.warn(`Season ${season.Season} has no episodes or target episode ${targetEpisodeNumber} not found.`); }
        }
        
        function playEpisode(episode) {
            currentEpisode = episode;
            elements.viewerTitle.textContent = `${currentSeries.Title} - Episode ${episode.Episode}`;
            elements.viewerDescription.textContent = episode.Description || currentSeries.Description;
            if (episode.Servers) updateQualitySelector(episode.Servers);
            if (episode.Servers && episode.Servers.length > 0) playUrl(episode.Servers[0].url);
            elements.episodeSelector.value = episode.Episode;
            updateNavButtonStates();
        }
        
        function closeViewerInternalLogic() {
            document.querySelector('.carousel').style.display = 'block'; document.querySelector('.filters-section').style.display = 'block'; document.querySelector('.content-container').style.display = 'block';
            elements.viewerPage.style.display = 'none';
            if (playerInstance) { playerInstance.pause(); playerInstance.stop(); }
            if (playerInstance && playerInstance.source) playerInstance.source = null;
            if (elements.videoDetailsContainer) { elements.videoDetailsContainer.appendChild(elements.episodeSelectorContainer); elements.videoDetailsContainer.appendChild(elements.seasonSelector); }
            elements.episodeSelectorContainer.style.display = 'none'; elements.seasonSelector.style.display = 'none';
            currentEpisode = null; currentSeason = null; currentSeries = null; currentContentInfo = {};
            window.scrollTo(0, 0);
        }
        function closeViewer() { closeViewerInternalLogic(); }
        
        function setupEventListeners() {
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.gridViewBtn.addEventListener('click', () => { elements.gridViewBtn.classList.add('active'); elements.listViewBtn.classList.remove('active'); currentView = 'grid'; renderCurrentView(); });
            elements.listViewBtn.addEventListener('click', () => { elements.listViewBtn.classList.add('active'); elements.gridViewBtn.classList.remove('active'); currentView = 'list'; renderCurrentView(); });
            elements.categoryFilter.addEventListener('change', renderContent); elements.genreFilter.addEventListener('change', renderContent); elements.countryFilter.addEventListener('change', renderContent); elements.sortFilter.addEventListener('change', renderContent);
            elements.searchInput.addEventListener('input', debounce(handleSearch, 300));
            elements.closeSearchBtn.addEventListener('click', function() { elements.searchInput.value = ''; elements.searchResults.style.display = 'none'; });
            elements.carouselPrev.addEventListener('click', () => { currentCarouselIndex = (currentCarouselIndex - 1 + elements.carouselInner.children.length) % elements.carouselInner.children.length; updateCarousel(); });
            elements.carouselNext.addEventListener('click', () => { currentCarouselIndex = (currentCarouselIndex + 1) % elements.carouselInner.children.length; updateCarousel(); });
            elements.mobileSearchBtn.addEventListener('click', () => { elements.searchContainer.style.display = 'block'; elements.searchInput.focus(); });
            document.addEventListener('click', (event) => { if (!elements.searchContainer.contains(event.target) && !elements.mobileSearchBtn.contains(event.target)) elements.searchContainer.style.display = 'none'; });
            window.addEventListener('scroll', () => { if (window.scrollY > 50) elements.header.classList.add('scrolled'); else elements.header.classList.remove('scrolled'); });
            elements.backButton.addEventListener('click', function() { history.back(); });
            elements.episodeSelector.addEventListener('change', function() { const episodeNum = parseInt(this.value); if (!currentSeason) return; const episode = currentSeason.Episodes.find(ep => ep.Episode === episodeNum); if (episode) playEpisode(episode); });
            window.addEventListener('popstate', function(event) {
                const state = event.state;
                if (elements.viewerPage.style.display === 'block' && (!state || state.page !== 'viewer')) {
                    closeViewerInternalLogic();
                    if (!state || state.page === 'browse') history.replaceState({ page: 'browse' }, 'Browse Content', window.location.pathname + window.location.search);
                } else if (state && state.page === 'viewer' && window.location.hash === '#viewer' && elements.viewerPage.style.display !== 'block') {
                    const contentToOpen = findContentById(state.contentId);
                    if (contentToOpen) openViewer(contentToOpen);
                    else { history.replaceState({ page: 'browse' }, 'Browse Content', window.location.pathname + window.location.search); closeViewerInternalLogic(); }
                }
            });
            elements.loadMoreBtn.addEventListener('click', loadMoreContent);
            window.addEventListener('scroll', () => { if (isFetching) return; const scrollPosition = window.innerHeight + window.scrollY; const documentHeight = document.documentElement.scrollHeight; if (scrollPosition >= documentHeight - LAZY_LOAD_THRESHOLD && currentPage < totalPages) loadMoreContent(); });
        }
        
        function toggleTheme() { document.body.classList.toggle('light-theme'); const icon = elements.themeToggle.querySelector('i'); if (document.body.classList.contains('light-theme')) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); document.body.style.backgroundColor = '#f0f0f0'; document.body.style.color = '#333'; } else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); document.body.style.backgroundColor = '#0f0f0f'; document.body.style.color = '#f5f5f5'; } }
        function debounce(func, wait) { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func.apply(this, args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        function handleSearch() {
            const query = elements.searchInput.value.toLowerCase(); elements.searchResults.innerHTML = ''; if (query.length < 2) { elements.searchResults.style.display = 'none'; return; }
            const results = []; cachedContent.forEach(item => { if (item.Title.toLowerCase().includes(query)) results.push({ title: item.Title, type: item.type === 'movie' ? 'Movie' : item.type === 'series' ? 'TV Series' : 'Live TV', thumbnail: item.Thumbnail || item.Poster, year: item.Year || '' }); });
            if (results.length > 0) { results.slice(0, 5).forEach(result => { const resultItem = document.createElement('div'); resultItem.className = 'search-result-item'; resultItem.innerHTML = `<img src="${result.thumbnail}" alt="${result.title}" onerror="this.onerror=null; this.src='${PLACEHOLDER_IMAGE_URL}';"><div class="search-result-info"><h4>${result.title}</h4><p>${result.type} • ${result.year || ''}</p></div>`; resultItem.addEventListener('click', () => { const found = cachedContent.find(item => item.Title === result.title); if (found) openViewer(found); elements.searchResults.style.display = 'none'; }); elements.searchResults.appendChild(resultItem); }); elements.searchResults.style.display = 'block'; } else { elements.searchResults.style.display = 'none'; }
        }
        function updateCarousel() { elements.carouselInner.style.transform = `translateX(-${currentCarouselIndex * 100}%)`; document.querySelectorAll('.indicator').forEach((indicator, index) => { if (index === currentCarouselIndex) indicator.classList.add('active'); else indicator.classList.remove('active'); }); }
        document.addEventListener('DOMContentLoaded', init);
        function displayTemporaryMessage(element, message) { const originalText = element.textContent; element.textContent = message; setTimeout(() => { element.textContent = originalText; }, 2000); }
        async function handleShareVideo() { /* ... (share logic remains same) ... */ }
        const INTERACTIONS_KEY = 'cineCrazeInteractions';
        function getVideoInteractions(contentId) { /* ... */ return { likes:0, dislikes:0, userAction: null };}
        function saveVideoInteractions(contentId, interactionData) { /* ... */ }
        function formatCount(count) { if (count >= 1000000) return (count / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'; if (count >= 1000) return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'K'; return count.toString(); }
        function updateLikeDislikeUI(contentId) { /* ... (like/dislike UI update remains same) ... */ }
        function handleLike() { /* ... */ }
        function handleDislike() { /* ... */ }
        const VIEW_COUNTS_KEY = 'cineCrazeViewCounts';
        function getViewCounts() { return JSON.parse(localStorage.getItem(VIEW_COUNTS_KEY)) || {}; }
        function incrementViewCount(contentId) { if (!contentId) return; const viewCounts = getViewCounts(); viewCounts[contentId] = (viewCounts[contentId] || 0) + 1; localStorage.setItem(VIEW_COUNTS_KEY, JSON.stringify(viewCounts)); const viewsElement = document.getElementById('viewer-views'); if (viewsElement) viewsElement.innerHTML = `<i class="fas fa-eye"></i> ${formatCount(viewCounts[contentId])} views`; }
        const mobileBtn = document.getElementById('mobile-search-btn');
        mobileBtn?.addEventListener('click', () => { elements.searchContainer.classList.toggle('show'); elements.searchInput.focus(); });
        elements.searchContainer?.addEventListener('click', (e) => { e.stopPropagation(); });
        document.addEventListener('click', (e) => { if (elements.searchContainer && !elements.searchContainer.contains(e.target) && elements.mobileSearchBtn && !elements.mobileSearchBtn.contains(e.target)) elements.searchContainer.classList.remove('show'); });
        function fixSearchVisibilityOnResize() { const isMobile = window.innerWidth <= 768; if (!isMobile && elements.searchContainer) { elements.searchContainer.classList.remove('show'); elements.searchContainer.style.display = 'block'; } else if (elements.searchContainer) { elements.searchContainer.style.display = '';} }
        window.addEventListener('resize', fixSearchVisibilityOnResize);
        window.addEventListener('load', fixSearchVisibilityOnResize);
    </script>

</body>
</html>